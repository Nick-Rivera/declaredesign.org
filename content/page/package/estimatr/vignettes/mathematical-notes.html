---
title: "Mathematical notes for estimatr"
author: "Luke Sonnet"
output:
  html_document:
    df_print: paged
link-citations: yes
bibliography: estimatr.bib
vignette: |
  %\VignetteIndexEntry{Mathematical notes for estimatr}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---



<p>This document provides the mathematical notes for each of the estimators in <code>estimatr</code>. The most up-to-date version of this can be found on the <a href="http://estimatr.declaredesign.org/articles/mathematical-notes.html">DeclareDesign website here</a>.</p>
<div id="estimators" class="section level1">
<h1>Estimators</h1>
<p>The current estimators we provide are:</p>
<ul>
<li><a href="#lm_robust-notes"><code>lm_robust</code></a> - for fitting linear models with heteroskedasticity/cluster-robust standard errors</li>
<li><a href="#lm_lin-notes"><code>lm_lin</code></a> - a wrapper for <code>lm_robust()</code> to simplify interacting centered pre-treatment covariates with a treatment variable</li>
<li><a href="#difference_in_means-notes"><code>difference_in_means</code></a> - for estimating differences in means with appropriate standard errors for unit-randomized, cluster-randomized, block-randomized, matched-pair randomized, and matched-pair clustered designs</li>
<li><a href="#horvitz_thompson-notes"><code>horvitz_thompson</code></a> - for estimating average treatment effects taking into consideration treatment probabilities or sampling probabilities for simple and cluster randomized designs</li>
</ul>
<div id="lm_robust-notes" class="section level2">
<h2><code>lm_robust</code> notes</h2>
<p>The <a href="#lm_robust"><code>lm_robust</code></a> method uses the C++ library <a href="https://eigen.tuxfamily.org/">Eigen</a>, via the <a href="https://github.com/RcppCore/RcppEigen"><code>RcppEigen</code></a> package, to estimate the coefficients, variance-covariance matrix, and, in some cases, the degrees of freedom of linear models.</p>
<p>The default estimators have been selected for efficiency in large samples and low bias in small samples as well as for their similarities to design-based randomization estimators <span class="citation">(Samii and Aronow <a href="#ref-samiiaronow2012">2012</a>)</span>. This section outlines the various kinds of variance estimators one can employ within <code>lm_robust</code>.</p>
<div id="coefficient-estimates" class="section level3">
<h3>Coefficient estimates</h3>
<p><span class="math display">\[
\widehat{\beta} =(\mathbf{X}^{\top}\mathbf{X})^{-1}\mathbf{X}^{\top}\mathbf{y}
\]</span></p>
<p>Our algorithm solves the least squares problem using a rank-revealing column-pivoting QR factorization that eliminates the need to invert <span class="math inline">\((\mathbf{X}^{\top}\mathbf{X})^{-1}\)</span> explicitly and behaves much like the default <code>lm</code> function in R. However, when <span class="math inline">\(\mathbf{X}\)</span> is rank deficient, there are certain conditions under which the QR factorization algorithm we use, from the Eigen C++ library, drops different coefficients from the output than the default <code>lm</code> function. In general, users should avoid specifing models with rank-deficiencies. In fact, if users are certain their data are not rank deficient, they can improve the speed of <code>lm_robust</code> by setting <code>try_cholesky = TRUE</code>. This replaces the QR factorization with a Cholesky factorization that is only guaranteed to work <span class="math inline">\(\mathbf{X}\)</span> is of full rank.</p>
<div id="weights" class="section level4">
<h4>Weights</h4>
<p>If weights are included, we transform the data as below and then proceed as normal, following advice from <span class="citation">Romano and Wolf (<a href="#ref-romanowolf2017">2017</a>)</span> that this weighted estimator has attractive properties. We do so by first scaling all of the weights so that they sum to one. Then we multiply each row of the design matrix <span class="math inline">\(\mathbf{X}\)</span> by the square root each unit’s weight, <span class="math inline">\(\mathbf{x}_i \sqrt{w_i}\)</span>, and then do the same to the outcome, <span class="math inline">\(\mathbf{y}_i \sqrt{w_i}\)</span>. This results in our coefficients being estimated as follows, where <span class="math inline">\(\mathbf{W}\)</span> is a diagonal matrix with the scaled weights on the diagonal.</p>
<p>Weighted:
<span class="math display">\[
\widehat{\beta} =(\mathbf{X}^{\top}\mathbf{W}\mathbf{X})^{-1}\mathbf{X}^{\top}\mathbf{W}\mathbf{y}
\]</span></p>
<p>The transformed data are then used in the analysis below, where <span class="math inline">\((\mathbf{X}^{\top}\mathbf{X})^{-1}\)</span> is now <span class="math inline">\((\mathbf{X}^{\top}\mathbf{W}\mathbf{X})^{-1}\)</span> and <span class="math inline">\(\mathbf{X}\)</span> is now <span class="math inline">\(\mathbf{X} \mathrm{sqrt}[W]\)</span>, where <span class="math inline">\(\mathrm{sqrt}[.]\)</span> is an operator that applies a square root to the coefficients of some matrix.</p>
<p>We should note that this transformation yields the same standard errors as specifying weights using <code>aweight</code> in Stata for the “classical”, “HC0”, and “HC1” (“stata”) variance estimators. Furthermore, in the clustered case, our weighted estimator for the “stata” cluster-robust variance also matches Stata. Thus Stata’s main robust standard error estimators, “HC1” and their clustered estimator, match our package when weights are applied. Nonetheless, Stata uses a slightly different Hat matrix and thus “HC2” and “HC3” estimates in Stata when weights are specified may differ from our estimates—<a href="http://estimatr.declaredesign.org/articles/stata-wls-hat.html">more on that here</a>.</p>
</div>
</div>
<div id="variance" class="section level3">
<h3>Variance</h3>
<p>In addition to solving for OLS coefficients faster than <code>lm</code>, we provide a variety of robust variance estimators. Below we outline them for the non-clustered and clustered cases. You can see some simulations about the unbiasedness of the classical variance estimators with homoskedasticity and the consistency of the HC2 estimators with heteroskedasticity in <a href="http://estimatr.declaredesign.org/articles/simulations-ols-variance.html">these simulations</a>.</p>
<div id="heteroskedasticity-robust-variance-and-degrees-of-freedom" class="section level4">
<h4>Heteroskedasticity-Robust Variance and Degrees of Freedom</h4>
<p>The default variance estimator without clusters is the HC2 variance, first proposed by <span class="citation">MacKinnon and White (<a href="#ref-mackinnonwhite1985">1985</a>)</span>. This estimator has the advantage of being equivalent to a conservative randomization-based “Neyman” estimator of the variance <span class="citation">(Samii and Aronow <a href="#ref-samiiaronow2012">2012</a>)</span>. Furthermore, while it is somewhat less efficient than the HC1 variance estimator, the default in Stata, it tends to perform better in small samples (evidence for that can be found in our simulations <a href="http://estimatr.declaredesign.org/articles/simulations-ols-variance.html#hc1-and-hc2-in-small-samples">here</a>).</p>
<table>
<colgroup>
<col width="14%" />
<col width="37%" />
<col width="8%" />
<col width="40%" />
</colgroup>
<thead>
<tr class="header">
<th><code>se_type =</code></th>
<th>Variance Estimator (<span class="math inline">\(\widehat{\mathbb{V}}[\widehat{\beta}]\)</span>)</th>
<th>Degrees of Freedom</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>&quot;classical&quot;</code></td>
<td><span class="math inline">\(\frac{\mathbf{e}^\top\mathbf{e}}{N-K} (\mathbf{X}^{\top}\mathbf{X})^{-1}\)</span></td>
<td>N - K</td>
<td></td>
</tr>
<tr class="even">
<td><code>&quot;HC0&quot;</code></td>
<td><span class="math inline">\((\mathbf{X}^{\top}\mathbf{X})^{-1}\mathbf{X}^{\top}\mathrm{diag}\left[e_i^2\right]\mathbf{X}(\mathbf{X}^{\top}\mathbf{X})^{-1}\)</span></td>
<td>N - K</td>
<td></td>
</tr>
<tr class="odd">
<td><code>&quot;HC1&quot;</code>, <code>&quot;stata&quot;</code></td>
<td><span class="math inline">\(\frac{N}{N-K}(\mathbf{X}^{\top}\mathbf{X})^{-1}\mathbf{X}^{\top}\mathrm{diag}\left[e_i^2\right]\mathbf{X}(\mathbf{X}^{\top}\mathbf{X})^{-1}\)</span></td>
<td>N - K</td>
<td>Often called the Eicker-Huber-White variance (or similar)</td>
</tr>
<tr class="even">
<td><code>&quot;HC2&quot;</code> (default)</td>
<td><span class="math inline">\((\mathbf{X}^{\top}\mathbf{X})^{-1}\mathbf{X}^{\top}\mathrm{diag}\left[\frac{e_i^2}{1-h_{ii}}\right]\mathbf{X}(\mathbf{X}^{\top}\mathbf{X})^{-1}\)</span></td>
<td>N - K</td>
<td></td>
</tr>
<tr class="odd">
<td><code>&quot;HC3&quot;</code></td>
<td><span class="math inline">\((\mathbf{X}^{\top}\mathbf{X})^{-1}\mathbf{X}{\top}\mathrm{diag}\left[\frac{e_i^2}{(1-h_{ii})^2}\right]\mathbf{X}(\mathbf{X}^{\top}\mathbf{X})^{-1}\)</span></td>
<td>N - K</td>
<td></td>
</tr>
</tbody>
</table>
<ul>
<li><span class="math inline">\(\mathbf{x}_i\)</span> is the <span class="math inline">\(i\)</span>th row of <span class="math inline">\(\mathbf{X}\)</span>.</li>
<li><span class="math inline">\(h_{ii} = \mathbf{x}_i(\mathbf{X}^{\top}\mathbf{X})^{-1}\mathbf{x}^{\top}_i\)</span></li>
<li><span class="math inline">\(e_i = y_i - \mathbf{x}_i\widehat{\beta}\)</span></li>
<li><span class="math inline">\(\mathrm{diag}[.]\)</span> is an operator that creates a diagonal matrix from a vector</li>
<li><span class="math inline">\(N\)</span> is the number of observations</li>
<li><span class="math inline">\(K\)</span> is the number of elements in <span class="math inline">\(\beta\)</span>.</li>
</ul>
</div>
<div id="cluster-robust-variance-and-degrees-of-freedom" class="section level4">
<h4>Cluster-Robust Variance and Degrees of Freedom</h4>
<p>For cluster-robust inference, we provide several estimators that are essentially analogs of the heteroskedastic-consistent variance estimators for the clustered case. Our default is the CR2 variance estimator, analogous to HC2 standard errors, and perform quite well in small samples without sacrificing much in the way of efficiency in larger samples. This estimator was originally proposed in <span class="citation">Bell and McCaffrey (<a href="#ref-bellmccaffrey2002">2002</a>)</span>, although we implement a generalized version of the algorithm outlined in <span class="citation">Pustejovsky and Tipton (<a href="#ref-pustejovskytipton2016">2016</a>)</span>; these authors provide an R package for CR2 variance estimation, <a href="https://github.com/jepusto/clubSandwich">clubSandwich</a>, that applies these standard errors to a wide variety of models. For a good overview of the different cluster-robust variance estimators and simulations of their accuracy in small samples, again users can see <span class="citation">Imbens and Kolesar (<a href="#ref-imbenskolesar2016">2016</a>)</span>. For an overview of when to use cluster-robust estimators, especially in an experimental setting, see <span class="citation">Abadie et al. (<a href="#ref-abadieetal2017">2017</a>)</span>.</p>
<table>
<colgroup>
<col width="4%" />
<col width="25%" />
<col width="17%" />
<col width="52%" />
</colgroup>
<thead>
<tr class="header">
<th><code>se_type =</code></th>
<th>Variance Estimator (<span class="math inline">\(\widehat{\mathbb{V}}[\widehat{\beta}]\)</span>)</th>
<th>Degrees of Freedom</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>&quot;CR0&quot;</code></td>
<td><span class="math inline">\((\mathbf{X}^{\top}\mathbf{X})^{-1} \sum^S_{s=1} \left[\mathbf{X}^\top_s \mathbf{e}_s\mathbf{e}^\top_s \mathbf{X}_s \right] (\mathbf{X}^{\top}\mathbf{X})^{-1}\)</span></td>
<td><span class="math inline">\(S - 1\)</span></td>
<td></td>
</tr>
<tr class="even">
<td><code>&quot;stata&quot;</code></td>
<td><span class="math inline">\(\frac{N-1}{N-K}\frac{S}{S-1} (\mathbf{X}^{\top}\mathbf{X})^{-1} \sum^S_{s=1} \left[\mathbf{X}^\top_s \mathbf{e}_s\mathbf{e}^\top_s \mathbf{X}_s \right] (\mathbf{X}^{\top}\mathbf{X})^{-1}\)</span></td>
<td><span class="math inline">\(S - 1\)</span></td>
<td>The Stata variance estimator is the same as the CR0 estimate but with a special finite-sample correction.</td>
</tr>
<tr class="odd">
<td><code>&quot;CR2&quot;</code> (default)</td>
<td><span class="math inline">\((\mathbf{X}^{\top}\mathbf{X})^{-1} \sum^S_{s=1} \left[\mathbf{X}^\top_s \mathbf{A}_s \mathbf{e}_s\mathbf{e}^\top_s \mathbf{A}^\top_s \mathbf{X}_s \right] (\mathbf{X}^{\top}\mathbf{X})^{-1}\)</span></td>
<td><span class="math inline">\(\frac{\left(\sum^S_{i = 1} \mathbf{p}^\top_i \mathbf{p}_i \right)^2}{\sum^S_{i=1}\sum^S_{j=1} \left(\mathbf{p}^\top_i \mathbf{p}_j \right)^2}\)</span></td>
<td>These estimates of the variance and degrees of freedom come from <span class="citation">Pustejovsky and Tipton (<a href="#ref-pustejovskytipton2016">2016</a>)</span>, which is an extension to certain models with a particular set of dummy variables of the method proposed by <span class="citation">Bell and McCaffrey (<a href="#ref-bellmccaffrey2002">2002</a>)</span>. Note that the degrees of freedom can vary for each coefficient. See below for more complete notation.</td>
</tr>
</tbody>
</table>
<ul>
<li><span class="math inline">\(S\)</span> is the number of clusters</li>
<li><span class="math inline">\(\mathbf{X}_s\)</span> is the rows of <span class="math inline">\(\mathbf{X}\)</span> that belong to cluster <span class="math inline">\(s\)</span></li>
<li><span class="math inline">\(I_n\)</span> is an identity matrix of size <span class="math inline">\(n\times n\)</span></li>
<li><span class="math inline">\(\mathbf{e}_s\)</span> is the elements of the residual matrix <span class="math inline">\(\mathbf{e}\)</span> in cluster <span class="math inline">\(s\)</span>, or <span class="math inline">\(\mathbf{e}_s = \mathbf{y}_s - \mathbf{X}_s \widehat{\beta}\)</span></li>
<li><span class="math inline">\(\mathbf{A}_s\)</span> and <span class="math inline">\(\mathbf{p}\)</span> are defined in the notes below</li>
</ul>
<p><strong>Further notes on CR2:</strong> The variance estimator we implement is shown in equations (4) and (5) in <span class="citation">Pustejovsky and Tipton (<a href="#ref-pustejovskytipton2016">2016</a>)</span> and equation (11), where we set <span class="math inline">\(\mathbf{\Phi}\)</span> to be <span class="math inline">\(I\)</span>, following <span class="citation">Bell and McCaffrey (<a href="#ref-bellmccaffrey2002">2002</a>)</span>. Furthernote that the <span class="citation">Pustejovsky and Tipton (<a href="#ref-pustejovskytipton2016">2016</a>)</span> CR2 estimator and the <span class="citation">Bell and McCaffrey (<a href="#ref-bellmccaffrey2002">2002</a>)</span> estimator are identical when <span class="math inline">\(\mathbf{B_s}\)</span> is full rank. It could be rank-deficient if there were dummy variables, or fixed effects, that were also your clusters. In this case, the original <span class="citation">Bell and McCaffrey (<a href="#ref-bellmccaffrey2002">2002</a>)</span> estimator could not be computed. You can see the simpler <span class="citation">Bell and McCaffrey (<a href="#ref-bellmccaffrey2002">2002</a>)</span> estimator written up plainly on page 709 of <span class="citation">Imbens and Kolesar (<a href="#ref-imbenskolesar2016">2016</a>)</span> along with the degrees of freedom denoted as <span class="math inline">\(K_{BM}\)</span>.</p>
<p>In the CR2 variance calculation, we get <span class="math inline">\(\mathbf{A}_s\)</span> as follows:</p>
<p><span class="math display">\[
\begin{aligned}
\mathbf{H} &amp;= \mathbf{X}(\mathbf{X}^{\top}\mathbf{X})^{-1}\mathbf{X}^\top \\\\\\ 
\mathbf{B}_s &amp;= (I_{N} - \mathbf{H})_s (I_{N} - \mathbf{H})^\top_s \\\\\\
\mathbf{A}_s &amp;= \mathbf{B}^{+1/2}_s
\end{aligned}
\]</span></p>
<p>where <span class="math inline">\(\mathbf{B}^{+1/2}_s\)</span> is the symmetric square root of the Moore–Penrose inverse of <span class="math inline">\(\mathbf{B}_s\)</span> and <span class="math inline">\((I - \mathbf{H})_s\)</span> are the <span class="math inline">\(N_s\)</span> columns that correspond to cluster <span class="math inline">\(s\)</span>. To get the corresponding degrees of freedom, note that</p>
<p><span class="math display">\[
\mathbf{p}_s = (I_N - \mathbf{H})^\top_s \mathbf{A}_s \mathbf{X}_s (\mathbf{X}^{\top}\mathbf{X})^{-1} \mathbf{z}_{k}
\]</span>
where <span class="math inline">\(\mathbf{z}_{k}\)</span> is a vector of length <span class="math inline">\(K\)</span>, the number of coefficients, where the <span class="math inline">\(k\)</span>th element is 1 and all other elements are 0. The <span class="math inline">\(k\)</span> signifies the coefficient for which we are computing the degrees of freedom.</p>
</div>
</div>
<div id="confidence-intervals-and-hypothesis-testing" class="section level3">
<h3>Confidence intervals and hypothesis testing</h3>
<p>If <span class="math inline">\(\widehat{\mathbb{V}}_k\)</span> is the <span class="math inline">\(k\)</span>th diagonal element of <span class="math inline">\(\widehat{\mathbb{V}}\)</span>, we build confidence intervals using the user specified <span class="math inline">\(\alpha\)</span> as:</p>
<p><span class="math display">\[
\mathrm{CI}^{1-\alpha} = \left(\widehat{\beta_k} + t^{df}_{\alpha/2} \sqrt{\widehat{\mathbb{V}}_k}, \widehat{\beta_k} + t^{df}_{1 - \alpha/2} \sqrt{\widehat{\mathbb{V}}_k}\right)
\]</span></p>
<p>We also provide two-sided p-values using a t-distribution with the aforementioned significance level <span class="math inline">\(\alpha\)</span> and degrees of freedom <span class="math inline">\(df\)</span>.</p>
</div>
</div>
<div id="lm_lin-notes" class="section level2">
<h2><code>lm_lin</code> notes</h2>
<p>The <a href="#lm_lin"><code>lm_lin</code></a> estimator is a data pre-processor for <code>lm_robust</code> that implements the regression method for covariate adjustment suggested by <span class="citation">Lin (<a href="#ref-lin2013">2013</a>)</span>.</p>
<p>This estimator works by taking the outcome and treatment variable as the main formula (<code>formula</code>) and takes a right-sided formula of all pre-treatment covariates (<code>covariates</code>). These pre-treatment covariates are then centered to be mean zero and interacted with the treatment variable before being added to the formula and passed to <code>lm_robust</code>. In other words, instead of fitting a simple model adjusting for pre-treatment covariates such as</p>
<p><span class="math display">\[
y_i = \tau z_i + \mathbf{\beta}^\top \mathbf{x}_i + \epsilon_i
\]</span></p>
<p>with the following model</p>
<p><span class="math display">\[
y_i = \tau z_i + \mathbf{\beta}^\top \mathbf{x}^c_i  + \mathbf{\gamma}^\top \mathbf{x}^c_i z_i + \epsilon_i
\]</span></p>
<p>where <span class="math inline">\(\mathbf{x}^c_i\)</span> is a vector of pre-treatment covariates for unit <span class="math inline">\(i\)</span> that have been centered to have mean zero and <span class="math inline">\(z_i\)</span> is an indicator for the treatment group. <span class="citation">Lin (<a href="#ref-lin2013">2013</a>)</span> proposed this estimator in response to the critique by <span class="citation">Freedman (<a href="#ref-freedman2008">2008</a>)</span> that using regression to adjust for pre-treatment covariates could bias estimates of treatment effects.</p>
<p>The estimator <code>lm_lin</code> also works for multi-valued treatments by creating a full set of dummies for each treatment level and interacting each with the centered pre-treatment covariates. The rest of the options for the function and corresponding estimation is identical to <a href="#lm_robust"><code>lm_robust</code></a>.</p>
</div>
<div id="difference_in_means-notes" class="section level2">
<h2><code>difference_in_means</code> notes</h2>
<p>There are six kinds of experimental designs for which our <a href="#difference_in_means"><code>difference_in_means</code></a> estimator can estimate treatment effects, standard errors, confidence intervals, and provide p-values. We list the different designs here along with how the software learns the design:</p>
<ul>
<li>Simple (both <code>clusters</code> and <code>blocks</code> are unused)</li>
<li>Clustered (<code>clusters</code> is specified while <code>blocks</code> is not)</li>
<li>Blocked (<code>blocks</code> is specified while <code>clusters</code> is not)</li>
<li>Blocked and clustered (both are specified)</li>
</ul>
<p>There are two subsets of blocked designs that we also consider:</p>
<ul>
<li>Matched-pairs (only <code>blocks</code> is specified and all blocks are size two)</li>
<li>Matched-pair clustered design (both names are specified and each block only has two clusters)</li>
</ul>
<p>For each design, our estimator is informed by the recent statistical literature on the analysis of experimental data.</p>
<div id="estimates" class="section level3">
<h3>Estimates</h3>
<p><strong>Any unblocked design</strong>
<span class="math display">\[
\widehat{\tau} = \frac{1}{N} \sum^N_{i=1} z_i y_i - (1 - z_i) y_i
\]</span>
where <span class="math inline">\(z_i\)</span> is the treatment variable, <span class="math inline">\(y_i\)</span> is the outcome, and <span class="math inline">\(N\)</span> is the total number of units.</p>
<p><strong>Blocked design (including matched-pairs designs)</strong>
<span class="math display">\[
\widehat{\tau} = \sum^J_{j=1} \frac{N_j}{N} \widehat{\tau_j}
\]</span>
where <span class="math inline">\(J\)</span> is the number of blocks, <span class="math inline">\(N_j\)</span> is the size of those blocks, and <span class="math inline">\(\widehat{\tau_j}\)</span> is the estimated difference-in-means in block <span class="math inline">\(j\)</span>.</p>
<div id="weighting" class="section level4">
<h4>Weighting</h4>
<p>If the user specifies weights, treatment effects (or block-level treatment effects) and their standard errors are estimated by <code>lm_robust</code>. There are three exceptions. First, we still compute the degrees of freedom as in the below table. Second, if the design is blocked, a weighted treatment effect and variance estimate are computed within each block using <code>lm_robust</code> and then combined as below. Third, specifying weights with a matched-pairs estimator in <code>difference_in_means</code> is not supported at the moment.</p>
</div>
</div>
<div id="variance-and-degrees-of-freedom" class="section level3">
<h3>Variance and Degrees of Freedom</h3>
<table>
<colgroup>
<col width="5%" />
<col width="15%" />
<col width="21%" />
<col width="56%" />
</colgroup>
<thead>
<tr class="header">
<th>Design type</th>
<th>Variance <span class="math inline">\(\widehat{\mathbb{V}}[\widehat{\tau}]\)</span></th>
<th>Degrees of Freedom</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>No blocks or clusters (standard)</td>
<td><span class="math inline">\(\frac{\widehat{\mathbb{V}}[y_{i,0}]}{N_0} + \frac{\widehat{\mathbb{V}}[y_{i,1}]}{N_1}\)</span></td>
<td><span class="math inline">\(\widehat{\mathbb{V}}[\widehat{\tau}]^2 \left(\frac{(\widehat{\mathbb{V}}[y_{i,1}]/ N_1)^2}{N_1 - 1} + \frac{(\widehat{\mathbb{V}}[y_{i,0}]/ N_0)^2}{N_0 - 1}\right)\)</span></td>
<td>Where <span class="math inline">\(\widehat{\mathbb{V}}[y_{i,k}]\)</span> is the Bessel-corrected variance of all units where <span class="math inline">\(z_i = k\)</span> and <span class="math inline">\(N_k\)</span> is the number of units in condition <span class="math inline">\(k\)</span>. This is equivalent to the variance and Welch–Satterthwaite approximation of the degrees of freedom used by R’s <code>t.test</code>.</td>
</tr>
<tr class="even">
<td>Blocked</td>
<td><span class="math inline">\(\sum^J_{j=1} \left(\frac{N_j}{N}\right)^2 \widehat{\mathbb{V}}[\widehat{\tau_j}]\)</span></td>
<td><span class="math inline">\(N - 2 * J\)</span></td>
<td>Where <span class="math inline">\(\widehat{\mathbb{V}}[\widehat{\tau_j}]\)</span> is the variance of the estimated difference-in-means in block <span class="math inline">\(j\)</span>. See footnote 17 on page 74 of <span class="citation">(Gerber and Green <a href="#ref-gerbergreen2012">2012</a>)</span> for a reference. The degrees of freedom are equivalent to a regression with a full set of block specific treatment effects.</td>
</tr>
<tr class="odd">
<td>Clusters</td>
<td>Same as <code>lm_robust</code> CR2 estimator</td>
<td>Same as <code>lm_robust</code> CR2 estimator</td>
<td>This variance is the same as that recommended by <span class="citation">Gerber and Green (<a href="#ref-gerbergreen2012">2012</a>)</span> in equation 3.23 on page 83 when the clusters are even sizes.</td>
</tr>
<tr class="even">
<td>Blocked and clustered</td>
<td><span class="math inline">\(\sum^J_{j=1} \left(\frac{N_j}{N}\right)^2 \widehat{\mathbb{V}}[\widehat{\tau_j}]\)</span></td>
<td><span class="math inline">\(S - 2 * J\)</span></td>
<td>Where <span class="math inline">\(\widehat{\mathbb{V}}[\widehat{\tau_j}]\)</span> is the variance of the estimated difference-in-means in block <span class="math inline">\(j\)</span> and S is the number of clusters. See footnote 17 on page 74 of <span class="citation">Gerber and Green (<a href="#ref-gerbergreen2012">2012</a>)</span> for a reference. The degrees of freedom are equivalent to a regression on data collapsed by cluster with a full set of block specific treatment effects.</td>
</tr>
<tr class="odd">
<td>Matched pairs</td>
<td><span class="math inline">\(\frac{1}{J(J-1)} \sum^J_{j=1} \left(\widehat{\tau_j} - \widehat{\tau}\right)^2\)</span></td>
<td><span class="math inline">\(J - 1\)</span></td>
<td>See equation 3.16 on page 77 of <span class="citation">Gerber and Green (<a href="#ref-gerbergreen2012">2012</a>)</span> for a reference.</td>
</tr>
<tr class="even">
<td>Matched pair cluster randomized</td>
<td><span class="math inline">\(\frac{J}{(J-1)N^2} \sum^J_{j=1} \left(N_j \widehat{\tau_j} - \frac{N \widehat{\tau}}{J}\right)^2\)</span></td>
<td><span class="math inline">\(J - 1\)</span></td>
<td>See the variance for the SATE defined in equation 6 on page 36 of <span class="citation">(Imai, King, and Nall <a href="#ref-imaietal2009">2009</a>)</span> and the suggested degrees of freedom on page 37.</td>
</tr>
</tbody>
</table>
</div>
<div id="confidence-intervals-and-hypothesis-testing-1" class="section level3">
<h3>Confidence intervals and hypothesis testing</h3>
<p>We build confidence intervals using the user specified <span class="math inline">\(\alpha\)</span> as:</p>
<p><span class="math display">\[
\mathrm{CI}^{1-\alpha} = \left(\widehat{\tau} + t^{df}_{\alpha/2} \sqrt{\widehat{\mathbb{V}}[\widehat{\tau}]},\widehat{\tau}] + t^{df}_{1 - \alpha/2} \sqrt{\widehat{\mathbb{V}}[\widehat{\tau}]}\right)
\]</span></p>
<p>We also provide two-sided p-values using a t-distribution with the aforementioned significance level <span class="math inline">\(\alpha\)</span> and degrees of freedom <span class="math inline">\(df\)</span>.</p>
</div>
</div>
<div id="horvitz_thompson-notes" class="section level2">
<h2><code>horvitz_thompson</code> notes</h2>
<p>We provide Horvitz-Thompson estimators for two-armed trials and can be used to estimate unbiased treatment effects when the randomization is known. Horvitz-Thompson estimators require information about the probability each unit is in treatment and control, as well as the joint probability each unit is in the treatment, in the control, and in opposite treatment conditions.</p>
<p>The estimator we implement here, <code>horvitz_thompson()</code>, can be told the design of an experiment in several ways, and the reference page is a good place to see some of those examples. Users can see a description of the estimator and its properties in <span class="citation">Aronow and Middleton (<a href="#ref-aronowmiddleton2013">2013</a>)</span>, <span class="citation">Middleton and Aronow (<a href="#ref-middletonaronow2015">2015</a>)</span>, and aronowsamii2017.</p>
<p>Some definitions used below:</p>
<ul>
<li><span class="math inline">\(\pi_{zi}\)</span> is the marginal probability of being in condition <span class="math inline">\(z \in \{0, 1\}\)</span> for unit i</li>
<li><span class="math inline">\(\pi_{ziwj}\)</span> is the joint probability of unit <span class="math inline">\(i\)</span> being in condition <span class="math inline">\(z\)</span> and unit <span class="math inline">\(j\)</span> being in condition <span class="math inline">\(w \in \{0, 1\}\)</span></li>
<li><span class="math inline">\(\epsilon_{ziwj}\)</span> is the indicator function <span class="math inline">\(\mathbb{1}\left(\pi_{ziwj} = 0\right)\)</span></li>
</ul>
<div id="estimates-1" class="section level3">
<h3>Estimates</h3>
<p><strong>Simple, complete, clustered</strong></p>
<p><span class="math display">\[
\widehat{\tau} = \frac{1}{N} \sum^N_{i=1} z_i \frac{y_i}{\pi_{1i}} - (1 - z_i) \frac{y_i}{\pi_{0i}} 
\]</span></p>
<p><strong>Blocked</strong></p>
<p><span class="math display">\[
\widehat{\tau} = \sum^J_{j=1} \frac{N_j}{N} \widehat{\tau_j}
\]</span>
where <span class="math inline">\(J\)</span> is the number of blocks, <span class="math inline">\(N_j\)</span> is the size of those blocks, and <span class="math inline">\(\widehat{\tau_j}\)</span> is the Horvitz-Thompson estimate in block <span class="math inline">\(j\)</span>.</p>
</div>
<div id="variance-1" class="section level3">
<h3>Variance</h3>
<p>Currently we provide variance estimates that rely on two separate assumptions:</p>
<ul>
<li><code>&quot;youngs&quot;</code> which implements a conservative variance estimate using Young’s inequality, described in equation 35 on page 147 of <span class="citation">Aronow and Middleton (<a href="#ref-aronowmiddleton2013">2013</a>)</span> and in <span class="citation">Aronow and Samii (<a href="#ref-aronowsamii2017">2017</a>)</span> on pages 11-15.</li>
<li><code>&quot;constant&quot;</code> which assumes constant treatment effects across all units but is less conservative. We only provide this estimator for simple randomized experiments.</li>
</ul>
<p><strong>Young’s inequality</strong></p>
<p>For designs that that are not clustered we use the following variance:</p>
<p><span class="math display">\[
\begin{aligned}
  \widehat{\mathbb{V}}_{Y}[\widehat{\tau}] = \frac{1}{N^2} \sum^N_{i=1} \Bigg[&amp; z_i \left(\frac{y_i}{\pi_{1i}}\right)^2 + (1 - z_i) \left(\frac{y_i}{\pi_{0i}}\right)^2 + \sum_{j \neq i} \bigg(\frac{z_i z_j}{\pi_{1i1j} + \epsilon_{1i1j}}(\pi_{1i1j} - \pi_{1i}\pi_{1j})\frac{y_i}{\pi_{1i}}\frac{y_j}{\pi_{1j}} \\\\\\
  &amp; + \frac{(1-z_i) (1-z_j)}{\pi_{0i0j} + \epsilon_{0i0j}}(\pi_{0i0j} - \pi_{0i}\pi_{0j})\frac{y_i}{\pi_{0i}}\frac{y_j}{\pi_{0j}} - 2 \frac{z_i (1-z_j)}{\pi_{1i0j} + \epsilon_{1i0j}}(\pi_{1i0j} - \pi_{1i}\pi_{0j})\frac{y_i}{\pi_{1i}}\frac{y_j}{\pi_{0j}} \\\\\\
  &amp; + \sum_{\forall j \colon \pi_{1i1j} = 0} \left( z_i \frac{y^2_i}{2\pi_{1i}} + z_j \frac{y^2_j}{\pi_{1j}}\right) + \sum_{\forall j \colon \pi_{0i0j} = 0} \left( (1-z_i) \frac{y^2_i}{2\pi_{0i}} + (1-z_j) \frac{y^2_j}{\pi_{0j}}\right)
  \Bigg]
\end{aligned}
\]</span></p>
<p>There are some simplifications of the above for simpler designs that follow algebraically from the above. For example, if there are no two units for which the joint probability of being in either condition is 0, which is the case for most experiments that are not matched-pair experiments, then we get:</p>
<p><span class="math display">\[
\begin{aligned}
  \widehat{\mathbb{V}}_{Y}[\widehat{\tau}] = \frac{1}{N^2} \sum^N_{i=1} \Bigg[&amp; z_i \left(\frac{y_i}{\pi_{1i}}\right)^2 + (1 - z_i) \left(\frac{y_i}{\pi_{0i}}\right)^2 + \sum_{j \neq i} \bigg(\frac{z_i z_j}{\pi_{1i1j}}(\pi_{1i1j} - \pi_{1i}\pi_{1j})\frac{y_i}{\pi_{1i}}\frac{y_j}{\pi_{1j}} \\\\\\
  &amp; + \frac{(1-z_i) (1-z_j)}{\pi_{0i0j}}(\pi_{0i0j} - \pi_{0i}\pi_{0j})\frac{y_i}{\pi_{0i}}\frac{y_j}{\pi_{0j}} - 2 \frac{z_i (1-z_j)}{\pi_{1i0j}}(\pi_{1i0j} - \pi_{1i}\pi_{0j})\frac{y_i}{\pi_{1i}}\frac{y_j}{\pi_{0j}}
  \Bigg]
\end{aligned}
\]</span></p>
<p>If we further simplify to the case where there is simple random assignment, and there is absolutely no dependence among units (i.e., <span class="math inline">\(\pi_{ziwj} = \pi_{zi}\pi_{wj} \;\;\forall\;\;z,w,i,j\)</span>), we get:</p>
<p><span class="math display">\[
\begin{aligned}
  \widehat{\mathbb{V}}_{Y}[\widehat{\tau}] = \frac{1}{N^2} \sum^N_{i=1} \Bigg[&amp; z_i \left(\frac{y_i}{\pi_{1i}}\right)^2 + (1 - z_i) \left(\frac{y_i}{\pi_{0i}}\right)^2\Bigg]
\end{aligned}
\]</span></p>
<p><strong>Clustered designs</strong></p>
<p>For clustered designs, we use the following collpased estimator by setting <code>collapsed = TRUE</code>. Here, <span class="math inline">\(M\)</span> is the total number of clusters, <span class="math inline">\(y_k\)</span> is the total of the outcomes <span class="math inline">\(y_i\)</span> for all <span class="math inline">\(i\)</span> units in cluster <span class="math inline">\(k\)</span>, <span class="math inline">\(\pi_zk\)</span> is the marginal probability of cluster <span class="math inline">\(k\)</span> being in condition <span class="math inline">\(z \in \{0, 1\}\)</span>, and <span class="math inline">\(z_k\)</span> and <span class="math inline">\(\pi_{zkwl}\)</span> are defined analogously. Warning! If one passes <code>condition_pr_mat</code> to <code>horvitz_thompson</code> for a clustered design, but not <code>clusters</code>, the function will not use the collapsed estimator the the variance estimate will be innacurate.</p>
<p><span class="math display">\[
\begin{aligned}
  \widehat{\mathbb{V}}_{Y}[\widehat{\tau}] = \frac{1}{N^2} \sum^M_{k=1} \Bigg[&amp; z_k \left(\frac{y_k}{\pi_{1k}}\right)^2 + (1 - z_k) \left(\frac{y_k}{\pi_{0k}}\right)^2 + \sum_{l \neq k} \bigg(\frac{z_k z_l}{\pi_{1k1l} + \epsilon_{1k1l}}(\pi_{1k1l} - \pi_{1k}\pi_{1l})\frac{y_k}{\pi_{1k}}\frac{y_l}{\pi_{1l}} \\\\\\
  &amp; + \frac{(1-z_k) (1-z_l)}{\pi_{0k0l} + \epsilon_{0k0l}}(\pi_{0k0l} - \pi_{0k}\pi_{0l})\frac{y_k}{\pi_{0k}}\frac{y_l}{\pi_{0l}} - 2 \frac{z_k (1-z_l)}{\pi_{1k0l} + \epsilon_{1k0l}}(\pi_{1k0l} - \pi_{1k}\pi_{0l})\frac{y_k}{\pi_{1k}}\frac{y_l}{\pi_{0l}} \\\\\\
  &amp; + \sum_{\forall l \colon \pi_{1k1l} = 0} \left( z_k \frac{y^2_k}{2\pi_{1k}} + z_l \frac{y^2_l}{\pi_{1l}}\right) + \sum_{\forall l \colon \pi_{0k0l} = 0} \left( (1-z_k) \frac{y^2_k}{2\pi_{0k}} + (1-z_l) \frac{y^2_l}{\pi_{0l}}\right)
  \Bigg]
\end{aligned}
\]</span></p>
<p><strong>Constant effects</strong></p>
<p>Alternatively, one can assume constant treatment effects and, under that assumption, estimate the variance that is consistent under that assumption but less conservative. Again, this estimator is only implemented for the simple randomized case.</p>
<ul>
<li><span class="math inline">\(y_{zi}\)</span> is the potential outcome for condition <span class="math inline">\(z\)</span> for unit <span class="math inline">\(i\)</span>. This is either observed if <span class="math inline">\(z_i = z\)</span> or estimated using the constant effects assumption if <span class="math inline">\(z_i \neq z\)</span>, where <span class="math inline">\(z_i\)</span> is the condition for unit <span class="math inline">\(i\)</span>. To be precise <span class="math inline">\(y_{1i} = z_i y_{i} + (1 - z_i) (y_{i} + \widehat{\tau})\)</span> and <span class="math inline">\(y_{0i} = z_i (y_{i} - \widehat{\tau}) + (1 - z_i) y_{i}\)</span>, where <span class="math inline">\(\widehat{\tau}\)</span> is the estimated treatment effect.</li>
</ul>
<p><span class="math display">\[
\begin{aligned}
    \widehat{\mathbb{V}}_{C}[\widehat{\tau}] = \frac{1}{N^2} \sum^N_{i=1} \Bigg[&amp; (1 - \pi_{0i}) \pi_{0i} \left(\frac{y_{0i}}{\pi_{0i}}\right)^2 + (1 - \pi_{1i}) \pi_{1i} \left(\frac{y_{1i}}{\pi_{1i}}\right)^2 - 2 y_{1i} y_{0i} \\\\\\
    &amp; + \sum_{j \neq i} \Big( (\pi_{0i0j} - \pi_{0i} \pi_{0j}) \frac{y_{0i}}{\pi_{0i}} \frac{y_{0j}}{\pi_{0j}} + (\pi_{1i1j} - \pi_{1i} \pi_{1j}) \frac{y_{1i}}{\pi_{1i}} \frac{y_{1j}}{\pi_{1j}} \\\\\\
    &amp;- 2 (\pi_{1i0j} - \pi_{1i} \pi_{0j}) \frac{y_{1i}}{\pi_{1i}} \frac{y_{0j}}{\pi_{0j}}
  \Big)\Bigg]
\end{aligned}
\]</span></p>
</div>
<div id="confidence-intervals-and-hypothesis-testing-2" class="section level3">
<h3>Confidence intervals and hypothesis testing</h3>
<p>Theory on hypothesis testing with the Horvitz-Thompson estimator is yet to be developed. We rely on a normal approximation and construct confidence intervals in the following way:
<span class="math display">\[
\mathrm{CI}^{1-\alpha} = \left(\widehat{\tau} + z_{\alpha/2} \sqrt{\widehat{\mathbb{V}}[\widehat{\tau}]}, \widehat{\tau} + z_{1 - \alpha/2} \sqrt{\widehat{\mathbb{V}}[\widehat{\tau}]}\right)
\]</span></p>
<p>The associated p-values for a two-sided null hypothesis test are computed using a normal disribution and the aforementioned significance level <span class="math inline">\(\alpha\)</span>.</p>
</div>
</div>
</div>
<div id="references" class="section level1 unnumbered">
<h1>References</h1>
<div id="refs" class="references">
<div id="ref-abadieetal2017">
<p>Abadie, Alberto, Susan Athey, Guido W Imbens, and Jeffrey Wooldridge. 2017. “A Class of Unbiased Estimators of the Average Treatment Effect in Randomized Experiments.” <em>arXiv Pre-Print</em>. <a href="https://arxiv.org/abs/1710.02926v2" class="uri">https://arxiv.org/abs/1710.02926v2</a>.</p>
</div>
<div id="ref-aronowmiddleton2013">
<p>Aronow, Peter M, and Joel A Middleton. 2013. “A Class of Unbiased Estimators of the Average Treatment Effect in Randomized Experiments.” <em>Journal of Causal Inference</em> 1 (1):135–54. <a href="https://doi.org/10.1515/jci-2012-0009" class="uri">https://doi.org/10.1515/jci-2012-0009</a>.</p>
</div>
<div id="ref-aronowsamii2017">
<p>Aronow, Peter M, and Cyrus Samii. 2017. “Estimating Average Causal Effects Under Interference Between Units.” <em>Annals of Applied Statistics</em>, forthcoming. <a href="https://arxiv.org/abs/1305.6156v3" class="uri">https://arxiv.org/abs/1305.6156v3</a>.</p>
</div>
<div id="ref-bellmccaffrey2002">
<p>Bell, Robert M, and Daniel F McCaffrey. 2002. “Bias Reduction in Standard Errors for Linear Regression with Multi-Stage Samples.” <em>Survey Methodology</em> 28 (2):169–82.</p>
</div>
<div id="ref-freedman2008">
<p>Freedman, David A. 2008. “On Regression Adjustments in Experiments with Several Treatments.” <em>The Annals of Applied Statistics</em>. JSTOR, 176–96. <a href="https://doi.org/10.1214/07-AOAS143" class="uri">https://doi.org/10.1214/07-AOAS143</a>.</p>
</div>
<div id="ref-gerbergreen2012">
<p>Gerber, Alan S, and Donald P Green. 2012. <em>Field Experiments: Design, Analysis, and Interpretation</em>. New York: W.W. Norton.</p>
</div>
<div id="ref-imaietal2009">
<p>Imai, Kosuke, Gary King, and Clayton Nall. 2009. “The Essential Role of Pair Matching in Cluster-Randomized Experiments, with Application to the Mexican Universal Health Insurance Evaluation.” <em>Statistical Science</em> 24 (1). Institute of Mathematical Statistics:29–53. <a href="https://doi.org/10.1214/08-STS274" class="uri">https://doi.org/10.1214/08-STS274</a>.</p>
</div>
<div id="ref-imbenskolesar2016">
<p>Imbens, Guido W, and Michal Kolesar. 2016. “Robust Standard Errors in Small Samples: Some Practical Advice.” <em>Review of Economics and Statistics</em> 98 (4). MIT Press:701–12. <a href="https://doi.org/10.1162/REST_a_00552" class="uri">https://doi.org/10.1162/REST_a_00552</a>.</p>
</div>
<div id="ref-lin2013">
<p>Lin, Winston. 2013. “Agnostic Notes on Regression Adjustments to Experimental Data: Reexamining Freedman’s Critique.” <em>The Annals of Applied Statistics</em> 7 (1). Institute of Mathematical Statistics:295–318. <a href="https://doi.org/10.1214/12-AOAS583" class="uri">https://doi.org/10.1214/12-AOAS583</a>.</p>
</div>
<div id="ref-mackinnonwhite1985">
<p>MacKinnon, James, and Halbert White. 1985. “Some Heteroskedasticity-Consistent Covariance Matrix Estimators with Improved Finite Sample Properties.” <em>Journal of Econometrics</em> 29 (3):305–25. <a href="https://doi.org/10.1016/0304-4076(85)90158-7" class="uri">https://doi.org/10.1016/0304-4076(85)90158-7</a>.</p>
</div>
<div id="ref-middletonaronow2015">
<p>Middleton, Joel A, and Peter M Aronow. 2015. “Unbiased Estimation of the Average Treatment Effect in Cluster-Randomized Experiments.” <em>Statistics, Politics and Policy</em> 6 (1-2):39–75. <a href="https://doi.org/10.1515/spp-2013-0002" class="uri">https://doi.org/10.1515/spp-2013-0002</a>.</p>
</div>
<div id="ref-pustejovskytipton2016">
<p>Pustejovsky, James E, and Elizabeth Tipton. 2016. “Small Sample Methods for Cluster-Robust Variance Estimation and Hypothesis Testing in Fixed Effects Models.” <em>Journal of Business &amp; Economic Statistics</em>. Taylor &amp; Francis. <a href="https://doi.org/10.1080/07350015.2016.1247004" class="uri">https://doi.org/10.1080/07350015.2016.1247004</a>.</p>
</div>
<div id="ref-romanowolf2017">
<p>Romano, Joseph P, and Michael Wolf. 2017. “Resurrecting Weighted Least Squares.” <em>Journal of Econometrics</em> 197 (1). Elsevier:1–19. <a href="https://doi.org/10.1016/j.jeconom.2016.10.003" class="uri">https://doi.org/10.1016/j.jeconom.2016.10.003</a>.</p>
</div>
<div id="ref-samiiaronow2012">
<p>Samii, Cyrus, and Peter M Aronow. 2012. “On Equivalencies Between Design-Based and Regression-Based Variance Estimators for Randomized Experiments.” <em>Statistics and Probability Letters</em> 82 (2). <a href="https://doi.org/10.1016/j.spl.2011.10.024" class="uri">https://doi.org/10.1016/j.spl.2011.10.024</a>.</p>
</div>
</div>
</div>
